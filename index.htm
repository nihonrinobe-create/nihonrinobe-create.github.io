<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ³¨æ–‡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --blue: #0055a4; --blue-dark: #003d7a; --blue-light: #e8f2fc;
  --green: #2e7d32; --red: #c62828; --bg: #f5f7fa; --card: #ffffff;
  --text: #1a1a1a; --text-sub: #5f6368; --border: #dce1e8;
  --radius: 14px; --orange-bg: #fff3e0; --orange-border: #ffcc80;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans JP',sans-serif; background:var(--bg); color:var(--text); line-height:1.6; padding-bottom:80px; }
.hero { background:linear-gradient(160deg,var(--blue),var(--blue-dark)); color:#fff; padding:30px 20px; text-align:center; }
.hero h1 { font-size:1.6rem; font-weight:700; }
.progress-bar { display:flex; gap:5px; padding:15px 20px; max-width:500px; margin:0 auto; }
.progress-step { flex:1; height:4px; background:var(--border); border-radius:2px; }
.progress-step.active { background:var(--blue); }
.progress-step.done { background:var(--green); }
.container { max-width:500px; margin:0 auto; padding:0 20px; }
.step { display:none; animation:fadeIn .3s ease; }
.step.active { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.card { background:var(--card); border-radius:var(--radius); box-shadow:0 2px 8px rgba(0,0,0,.06); padding:20px; margin-bottom:15px; border:1px solid var(--border); }
.card-title { font-weight:700; color:var(--blue); margin-bottom:15px; display:flex; align-items:center; gap:8px; }
.field { margin-bottom:18px; }
.field label { display:block; font-weight:600; font-size:.9rem; margin-bottom:6px; }
.field input, .field select, .field textarea { width:100%; padding:12px; border:2px solid var(--border); border-radius:10px; font-size:1rem; -webkit-appearance:none; background:#fff; }
.field-hint { font-size:.75rem; color:var(--text-sub); margin-top:5px; }
.error-msg { color:var(--red); font-size:.8rem; display:none; margin-top:5px; }
.field.error input, .field.error select, .field.error textarea { border-color:var(--red); background:#fff8f8; }
.field.error .error-msg { display:block; }

.system-fields { background:#f0f4f8; padding:15px; border-radius:10px; margin-bottom:20px; border:1px solid #dce1e8; }
.case-id-group { display:flex; gap:8px; }
.case-id-group select { width:35%; background:#fff; }
.case-id-group input { width:65%; }

.symptom-grid, .order-type-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.payment-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; }
.symptom-label, .order-type-label, .payment-label {
  border:2px solid var(--border); border-radius:10px; padding:12px 5px; text-align:center;
  font-size:.9rem; font-weight:600; cursor:pointer; background:#fff; transition:all .2s;
  display:flex; align-items:center; justify-content:center; min-height:50px;
}
.symptom-label input, .order-type-label input, .payment-label input { display:none; }
.symptom-label:has(input:checked), .order-type-label:has(input:checked), .payment-label:has(input:checked) {
  border-color:var(--blue); background:var(--blue-light); color:var(--blue);
}

#repair_options_area { margin-top:15px; padding:15px; background:var(--blue-light); border-radius:10px; display:none; }
.repair-item-row { display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid var(--border); border-radius:8px; padding:12px; margin-bottom:8px; }
.repair-item-row.active { border-color:var(--blue); box-shadow:0 0 0 1px var(--blue) inset; }
.repair-info { font-size:.9rem; font-weight:500; flex:1; padding-right:10px; }
.repair-price { font-size:.8rem; color:var(--text-sub); display:block; }
.counter-ui { display:flex; align-items:center; gap:10px; }
.btn-circle { width:32px; height:32px; border-radius:50%; border:none; font-size:1.2rem; cursor:pointer; display:flex; align-items:center; justify-content:center; background:#eee; color:#555; }
.btn-plus { background:var(--blue); color:#fff; }
.count-num { font-weight:700; width:24px; text-align:center; }

.discount-box { margin-top:20px; padding:15px; background:var(--orange-bg); border:1px solid var(--orange-border); border-radius:10px; }
.btn-apply { background:#e65100; color:#fff; border:none; padding:0 15px; border-radius:8px; font-weight:bold; cursor:pointer; }
.coupon-success { color:var(--green); font-weight:bold; }
.coupon-error { color:var(--red); font-weight:bold; }

.emergency-box { margin-top:20px; padding-top:15px; border-top:2px dashed #ddd; }
.emergency-label { display:flex; gap:10px; align-items:center; cursor:pointer; background:#fff5f5; padding:12px; border:1px solid #ffcccc; border-radius:8px; }
.emergency-label input { transform:scale(1.3); }
.emergency-label span { color:var(--red); font-weight:700; }

.agreement-box { background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-top:20px; }
.checkbox-group label { display:flex; gap:10px; align-items:flex-start; cursor:pointer; margin-bottom:12px; font-size:.9rem; padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff; }
.checkbox-group input[type="checkbox"] { margin-top:4px; transform:scale(1.2); flex-shrink:0; }

.consent-input-box { padding:10px; border:1px solid var(--border); border-radius:8px; background:#fff; margin-bottom:12px; }
.consent-input-box label { font-weight:600; font-size:.9rem; margin-bottom:8px; display:block; }
.consent-input-box input[type="text"] { width:100%; padding:10px; border:2px solid var(--border); border-radius:8px; font-size:.95rem; }
.consent-input-box .field-hint { font-size:.75rem; color:var(--text-sub); margin-top:5px; }

.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:#fff; padding:15px 20px; display:flex; gap:10px; justify-content:center; box-shadow:0 -2px 10px rgba(0,0,0,.05); z-index:100; }
.btn { padding:12px 24px; border-radius:10px; font-weight:700; border:none; cursor:pointer; flex:1; max-width:200px; text-align:center; }
.btn-next { background:var(--blue); color:#fff; }
.btn-back { background:#eee; color:#555; }
.btn:disabled { opacity:.6; cursor:not-allowed; }

.confirm-row { display:flex; border-bottom:1px solid #eee; padding:8px 0; font-size:.95rem; }
.confirm-label { width:100px; color:var(--text-sub); flex-shrink:0; }
.confirm-val { flex:1; font-weight:600; }

.complete-screen { text-align:center; padding:40px 20px; }
.complete-icon { font-size:3rem; margin-bottom:15px; }
</style>
</head>
<body>

<div class="hero">
  <h1>æ³¨æ–‡å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h1>
</div>

<div class="progress-bar">
  <div class="progress-step active" id="p1"></div>
  <div class="progress-step" id="p2"></div>
  <div class="progress-step" id="p3"></div>
  <div class="progress-step" id="p4"></div>
  <div class="progress-step" id="p5"></div>
  <div class="progress-step" id="p6"></div>
  <div class="progress-step" id="p7"></div>
</div>

<div class="container">

  <!-- ===== STEP 1: é¡§å®¢æƒ…å ± ===== -->
  <div class="step active" id="step1">
    <div class="card">
      <div class="card-title">ğŸ“‹ ç®¡ç†æƒ…å ±</div>
      <div class="system-fields">
        <div class="field">
          <label>æ¡ˆä»¶ID</label>
          <div class="case-id-group">
            <select id="c_case_prefix">
              <option value="AC">AC</option>
              <option value="HM">HM</option>
              <option value="CP">CP</option>
            </select>
            <input type="text" id="c_case_num" placeholder="ä¾‹: 20260212-001">
          </div>
        </div>
        <div class="field">
          <label>æ‹…å½“è€…ID</label>
          <input type="text" id="c_emp_id" placeholder="ä¾‹: T001">
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±</div>
      <div class="field" id="f_name">
        <label>ãŠåå‰ <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <input type="text" id="c_name" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
        <div class="error-msg">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_kana">
        <label>ãµã‚ŠãŒãª</label>
        <input type="text" id="c_kana" placeholder="ä¾‹ï¼šã‚„ã¾ã ãŸã‚ã†">
        <div class="error-msg">ãµã‚ŠãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_tel">
        <label>é›»è©±ç•ªå· <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <input type="tel" id="c_tel" inputmode="tel" placeholder="ä¾‹ï¼š09012345678">
        <div class="error-msg">é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_email">
        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <input type="email" id="c_email" inputmode="email" placeholder="ä¾‹ï¼šyamada@example.com">
        <div class="error-msg">æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_zip">
        <label>éƒµä¾¿ç•ªå·</label>
        <input type="text" id="c_zip" inputmode="numeric" maxlength="7" placeholder="ä¾‹ï¼š1730001" oninput="autoFillAddress(this.value)">
      </div>
      <div class="field" id="f_address">
        <label>ä½æ‰€ï¼ˆç•ªåœ°ä»¥å¤–ï¼‰</label>
        <input type="text" id="c_address" placeholder="è‡ªå‹•å…¥åŠ› or æ‰‹å…¥åŠ›">
        <div class="error-msg">ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_banchi">
        <label>ç•ªåœ° <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <input type="text" id="c_banchi" placeholder="ä¾‹ï¼š1-2-3">
        <div class="error-msg">ç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_building">
        <label>å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·</label>
        <input type="text" id="c_building" placeholder="ä¾‹ï¼šâ—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³ 101">
      </div>
    </div>
  </div>

  <!-- ===== STEP 2: ä¾é ¼å†…å®¹ ===== -->
  <div class="step" id="step2">
    <div class="card">
      <div class="card-title">ğŸ”§ ã”ä¾é ¼å†…å®¹</div>
      <div class="field" id="f_equipment">
        <label>å¯¾è±¡æ©Ÿå™¨ <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <select id="c_equipment">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³">ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³</option>
          <option value="æ¥­å‹™ç”¨ã‚¨ã‚¢ã‚³ãƒ³">æ¥­å‹™ç”¨ã‚¨ã‚¢ã‚³ãƒ³</option>
          <option value="ã‚¨ã‚³ã‚­ãƒ¥ãƒ¼ãƒˆ">ã‚¨ã‚³ã‚­ãƒ¥ãƒ¼ãƒˆ</option>
          <option value="ã‚¬ã‚¹çµ¦æ¹¯å™¨">ã‚¬ã‚¹çµ¦æ¹¯å™¨</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <div class="error-msg">å¯¾è±¡æ©Ÿå™¨ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field" id="f_symptom">
        <label>ç—‡çŠ¶ï¼ˆè¤‡æ•°å¯ï¼‰ <span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
        <div class="symptom-grid">
          <label class="symptom-label"><input type="checkbox" name="symptom" value="å†·ãˆãªã„ãƒ»æš–ã¾ã‚‰ãªã„">å†·ãˆãªã„<br>æš–ã¾ã‚‰ãªã„</label>
          <label class="symptom-label"><input type="checkbox" name="symptom" value="æ°´æ¼ã‚Œã—ã¦ã„ã‚‹">æ°´æ¼ã‚Œ<br>ã—ã¦ã„ã‚‹</label>
          <label class="symptom-label"><input type="checkbox" name="symptom" value="é›»æºãŒå…¥ã‚‰ãªã„">é›»æºãŒ<br>å…¥ã‚‰ãªã„</label>
          <label class="symptom-label"><input type="checkbox" name="symptom" value="ç•°éŸ³ãƒ»ã«ãŠã„ãŒã™ã‚‹">ç•°éŸ³ãƒ»ã«ãŠã„<br>ãŒã™ã‚‹</label>
          <label class="symptom-label"><input type="checkbox" name="symptom" value="ãƒ©ãƒ³ãƒ—ãŒç‚¹æ»…">ãƒ©ãƒ³ãƒ—ãŒ<br>ç‚¹æ»…</label>
          <label class="symptom-label"><input type="checkbox" name="symptom" value="ãã®ä»–">ãã®ä»–</label>
        </div>
        <div class="error-msg">ç—‡çŠ¶ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„</div>
      </div>
      <div class="field">
        <label>ä½œæ¥­ç¨®åˆ¥</label>
        <div class="order-type-grid">
          <label class="order-type-label"><input type="radio" name="order_type" value="åŸå› ç©¶æ˜ä½œæ¥­" checked>åŸå› ç©¶æ˜ä½œæ¥­</label>
          <label class="order-type-label"><input type="radio" name="order_type" value="ä¿®ç†" onclick="toggleRepairMenu()">ä¿®ç†</label>
        </div>
        <div id="repair_options_area">
          <div class="repair-item-row" data-price="29700" data-name="å†·åª’ã‚¬ã‚¹æ³¨å…¥"><div class="repair-info">å†·åª’ã‚¬ã‚¹æ³¨å…¥ï¼ˆ500gã¾ã§ï¼‰<span class="repair-price">29,700å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="3300" data-name="å†·åª’ã‚¬ã‚¹è¿½åŠ ï¼ˆ100gï¼‰"><div class="repair-info">å†·åª’ã‚¬ã‚¹è¿½åŠ ï¼ˆ100gï¼‰<span class="repair-price">3,300å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="17600" data-name="çœŸç©ºå¼•ã"><div class="repair-info">çœŸç©ºå¼•ã<span class="repair-price">17,600å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="17600" data-name="ãƒ•ãƒ¬ã‚¢åŠ å·¥ãƒ»ãƒãƒ«ãƒ–ã‚³ã‚¢äº¤æ›"><div class="repair-info">ãƒ•ãƒ¬ã‚¢åŠ å·¥ãƒ»ãƒãƒ«ãƒ–ã‚³ã‚¢äº¤æ›<span class="repair-price">17,600å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="28600" data-name="æ°´æ¼ã‚Œä¿®å¾©"><div class="repair-info">æ°´æ¼ã‚Œä¿®å¾©<span class="repair-price">28,600å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="26400" data-name="å››æ–¹å¼å‹•ä½œä¸è‰¯è§£æ¶ˆ"><div class="repair-info">å››æ–¹å¼å‹•ä½œä¸è‰¯è§£æ¶ˆ<span class="repair-price">26,400å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="26400" data-name="é›»æºéƒ¨å†æ¥ç¶š"><div class="repair-info">é›»æºéƒ¨å†æ¥ç¶š<span class="repair-price">26,400å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="28600" data-name="ã‚¨ã‚¢ã‚³ãƒ³æ¨™æº–å–ä»˜"><div class="repair-info">ã‚¨ã‚¢ã‚³ãƒ³æ¨™æº–å–ä»˜<span class="repair-price">28,600å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="8800" data-name="ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šå¤–ã—"><div class="repair-info">ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šå¤–ã—<span class="repair-price">8,800å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
          <div class="repair-item-row" data-price="26400" data-name="ç©´é–‹ã‘å·¥äº‹"><div class="repair-info">ç©´é–‹ã‘å·¥äº‹<span class="repair-price">26,400å††ã€œ</span></div><div class="counter-ui"><button class="btn-circle btn-minus" onclick="changeCount(this,-1)">-</button><span class="count-num">0</span><button class="btn-circle btn-plus" onclick="changeCount(this,1)">+</button></div></div>
        </div>
      </div>
      <div class="field">
        <label>è©³ç´°ãƒ»è£œè¶³</label>
        <textarea id="c_detail" rows="3" placeholder="å‹ç•ªãƒ»ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»ãã®ä»–ã”è¦æœ›ãªã©"></textarea>
      </div>
    </div>
  </div>

  <!-- ===== STEP 3: æ–™é‡‘ãƒ»æ”¯æ‰•ã„ ===== -->
  <div class="step" id="step3">
    <div class="card">
      <div class="card-title">ğŸ’° æ–™é‡‘ãƒ»ãŠæ”¯æ‰•ã„</div>
      <div class="discount-box">
        <label style="font-weight:600;font-size:.9rem">ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰ / ç´¹ä»‹ã‚³ãƒ¼ãƒ‰</label>
        <div style="display:flex;gap:10px;margin-top:5px">
          <input type="text" id="c_coupon_code" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="flex:1">
          <button type="button" class="btn-apply" onclick="applyCoupon()">é©ç”¨</button>
        </div>
        <div id="coupon_result" style="font-size:.85rem;margin-top:5px;font-weight:bold"></div>
      </div>
      <div class="field" style="margin-top:20px">
        <label>ãŠæ”¯æ‰•ã„æ–¹æ³•</label>
        <div class="payment-grid">
          <label class="payment-label"><input type="radio" name="payment_method" value="ç¾é‡‘" checked>ç¾é‡‘</label>
          <label class="payment-label"><input type="radio" name="payment_method" value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</label>
          <label class="payment-label"><input type="radio" name="payment_method" value="ã”ç›¸è«‡">ã”ç›¸è«‡</label>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== STEP 4: ç¢ºèª ===== -->
  <div class="step" id="step4">
    <div class="card">
      <div class="card-title">âœ… å…¥åŠ›å†…å®¹ã®ç¢ºèª</div>
      <div id="confirmContent"></div>
    </div>
  </div>

  <!-- ===== STEP 5: è¦‹ç©æ›¸ ===== -->
  <div class="step" id="step5">
    <div class="card">
      <div class="card-title">ğŸ“„ ãŠè¦‹ç©ã‚Šå†…å®¹</div>
      <div style="background:#f0f7ff;border:2px solid var(--blue);border-radius:10px;padding:20px;margin-bottom:15px">
        <div style="text-align:center;font-size:1.1rem;font-weight:bold;color:var(--blue);margin-bottom:15px">å¾¡ è¦‹ ç© æ›¸</div>
        <div id="est_customer_name" style="font-size:.95rem;margin-bottom:10px"></div>
        <div id="est_date" style="font-size:.85rem;color:#666;margin-bottom:15px"></div>
        <table style="width:100%;border-collapse:collapse;font-size:.9rem">
          <thead>
            <tr style="background:var(--blue);color:#fff">
              <th style="padding:8px;text-align:left;border-radius:4px 0 0 0">é …ç›®</th>
              <th style="padding:8px;text-align:right;width:70px">å˜ä¾¡</th>
              <th style="padding:8px;text-align:center;width:40px">æ•°</th>
              <th style="padding:8px;text-align:right;border-radius:0 4px 0 0;width:80px">å°è¨ˆ</th>
            </tr>
          </thead>
          <tbody id="est_items_body"></tbody>
        </table>
        <div style="margin-top:15px;padding:15px;background:#fff;border-radius:8px;border:2px solid var(--blue)">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:1rem;font-weight:bold">åˆè¨ˆé‡‘é¡ï¼ˆç¨è¾¼ï¼‰</span>
            <span id="est_total" style="font-size:1.5rem;font-weight:bold;color:var(--blue)"></span>
          </div>
        </div>
      </div>
      <div style="font-size:.85rem;color:#666">
        <p>â€»ä¸Šè¨˜ã¯æ¦‚ç®—ã®ãŠè¦‹ç©ã‚Šã§ã™ã€‚ç¾åœ°ã®çŠ¶æ³ã«ã‚ˆã‚Šé‡‘é¡ãŒå¤‰æ›´ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        <p>â€»è¿½åŠ ä½œæ¥­ãŒå¿…è¦ãªå ´åˆã¯ã€åˆ¥é€”ãŠè¦‹ç©ã‚Šãƒ»åŒæ„ã®ä¸Šã§å®Ÿæ–½ã—ã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <!-- ===== STEP 6: å¥‘ç´„ãƒ»åŒæ„ ===== -->
  <div class="step" id="step6">
    <div class="card">
      <div class="card-title">ğŸ§¾ å¥‘ç´„ãƒ»åŒæ„ <span style="color:var(--red)">(é‡è¦)</span></div>

      <div class="field" style="background:#f9f9f9;padding:15px;border-radius:8px">
        <label id="fee_label">è²»ç”¨ï¼ˆç¨è¾¼ï¼‰</label>
        <input type="text" id="fee_diagnosis" readonly style="font-weight:bold;color:var(--blue);font-size:1.2rem;background:#fff;border:none">
        <div class="field-hint">â€»ç¾åœ°ã§è¿½åŠ ä½œæ¥­ãŒå¿…è¦ãªå ´åˆã¯ã€åˆ¥é€”ãŠè¦‹ç©ã‚Šãƒ»åŒæ„ã®ä¸Šã§å®Ÿæ–½ã—ã¾ã™ã€‚</div>
      </div>

      <div class="field">
        <label>ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦å®š</label>
        <textarea id="cancel_rule" readonly style="height:60px;font-size:.85rem;background:#eee">å½“æ—¥ãƒ»å‡ºç™ºå¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯è²»ç”¨ã®100%ã‚’ç”³ã—å—ã‘ã¾ã™ã€‚</textarea>
      </div>

      <div class="emergency-box">
        <label class="emergency-label">
          <input type="checkbox" id="req_sameday">
          <span>ç·Šæ€¥äº‹æ…‹ã«ã¤ãå½“æ—¥ã®å·¥äº‹ã‚’å¸Œæœ›ã—ã¾ã™</span>
        </label>
      </div>

      <div class="agreement-box">
        <div class="checkbox-group">
          <!-- â‘  å¥‘ç´„åŒæ„ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§OKï¼‰ -->
          <label>
            <input type="checkbox" id="agree_contract">
            <span>ä¸Šè¨˜é‡‘é¡ãŠã‚ˆã³ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦å®šã«åŒæ„ã—ã¦ç”³ã—è¾¼ã¿ã¾ã™ã€‚</span>
          </label>

          <!-- â‘¡ é›»å­äº¤ä»˜ã®æ‰¿è«¾ï¼ˆâ˜…ç‰¹å•†æ³•å¯¾å¿œï¼šæ–‡ç« æ‰‹å…¥åŠ›â˜…ï¼‰ -->
          <div class="consent-input-box">
            <label><b>ã€é›»å­äº¤ä»˜ã¸ã®æ‰¿è«¾ã€‘</b></label>
            <p style="font-size:.85rem;color:#333;margin-bottom:10px">
              å¥‘ç´„æ›¸é¢ç­‰ã‚’ã€ç´™åª’ä½“ã«ä»£ãˆã¦PDFãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹ã“ã¨ã«åŒæ„ã™ã‚‹å ´åˆã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚³ãƒ”ãƒ¼ã—ã€å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
            </p>
            <div style="background:#e8f2fc;border:2px solid var(--blue);border-radius:8px;padding:14px;margin-bottom:8px;text-align:center">
              <div style="font-size:1rem;font-weight:700;color:var(--blue);margin-bottom:10px;line-height:1.5">å¥‘ç´„æ›¸é¢ç­‰ã‚’PDFãƒ¡ãƒ¼ãƒ«ã§<br>å—é ˜ã™ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™</div>
              <button type="button" onclick="copyConsent()" style="background:var(--blue);color:#fff;border:none;border-radius:8px;padding:10px 24px;font-size:.9rem;font-weight:700;cursor:pointer" id="btn_copy_consent">ğŸ“‹ ã“ã®æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div style="font-size:.8rem;color:var(--text-sub);margin-bottom:8px">â†“ ã‚³ãƒ”ãƒ¼ã—ãŸã‚‰ä¸‹ã®æ¬„ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</div>
            <input type="text" id="consent_text" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘" style="font-size:1rem;text-align:center">
          </div>

          <!-- â‘¢ å€‹äººæƒ…å ±åŒæ„ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§OKï¼‰ -->
          <label>
            <input type="checkbox" id="agree_privacy">
            <span>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ï¼ˆæ¥­å‹™å§”è¨—å…ˆã¸ã®å…±æœ‰ã‚’å«ã‚€ï¼‰ã€‚</span>
          </label>
        </div>

        <div class="field" style="margin-top:20px">
          <label>ã”ç½²åï¼ˆãŠåå‰ã‚’å…¥åŠ›ï¼‰<span style="color:red;font-size:.8rem">â€»å¿…é ˆ</span></label>
          <input type="text" id="c_signature" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
          <div class="field-hint">å¥‘ç´„ã®è¨¼ã¨ã—ã¦ã€ã”æœ¬äººæ§˜ã®ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
      </div>

      <div class="error-msg" id="agree_error" style="margin-top:10px">ã™ã¹ã¦ã®åŒæ„äº‹é …ã‚’æº€ãŸã—ã€ã”ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- ===== STEP 7: å®Œäº† ===== -->
  <div class="step" id="step7">
    <div class="complete-screen">
      <div class="complete-icon">ğŸ‰</div>
      <h2>å—ä»˜å®Œäº†ã—ã¾ã—ãŸ</h2>
      <p>ã”ç™»éŒ²ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã€Œå¥‘ç´„æ›¸æ§ãˆï¼ˆPDFï¼‰ã€ã‚’ãŠé€ã‚Šã—ã¾ã—ãŸã€‚<br>æ‹…å½“è€…ã‚ˆã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚</p>
    </div>
  </div>

</div>

<div class="bottom-nav">
  <button class="btn btn-back" onclick="prevStep()" id="btnBack" style="display:none">æˆ»ã‚‹</button>
  <button class="btn btn-next" onclick="nextStep()" id="btnNext">æ¬¡ã¸</button>
</div>

<script>
// ================================
// â˜… GAS Webã‚¢ãƒ—ãƒªã®URLã‚’ã“ã“ã«è²¼ã‚‹ â˜…
// ================================
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwGxE0VcPv6SAL14PGpm0_a_TTIrudeuq8NE27LVQmdYMA_zIaGG1lcNg0u-y6FsfK77A/exec';

let currentStep = 1;
let couponApplied = false;
const CONSENT_PHRASE = 'å¥‘ç´„æ›¸é¢ç­‰ã‚’PDFãƒ¡ãƒ¼ãƒ«ã§å—é ˜ã™ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™';

// === æ‰¿è«¾æ–‡ã‚³ãƒ”ãƒ¼ ===
function copyConsent() {
  const text = CONSENT_PHRASE;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      document.getElementById('btn_copy_consent').textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
      setTimeout(() => { document.getElementById('btn_copy_consent').textContent = 'ğŸ“‹ ã“ã®æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼'; }, 2000);
    }).catch(() => { fallbackCopy(text); });
  } else { fallbackCopy(text); }
}
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  document.getElementById('btn_copy_consent').textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
  setTimeout(() => { document.getElementById('btn_copy_consent').textContent = 'ğŸ“‹ ã“ã®æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼'; }, 2000);
}

// === URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è‡ªå‹•å…¥åŠ› ===
window.onload = function() {
  const p = new URLSearchParams(location.search);
  if (p.get('case_id')) {
    const parts = p.get('case_id').split('-');
    if (parts.length > 1 && ['AC','HM','CP'].includes(parts[0])) {
      document.getElementById('c_case_prefix').value = parts[0];
      document.getElementById('c_case_num').value = parts.slice(1).join('-');
    } else {
      document.getElementById('c_case_num').value = p.get('case_id');
    }
  }
  if (p.get('emp_id'))  document.getElementById('c_emp_id').value = p.get('emp_id');
  if (p.get('name'))    document.getElementById('c_name').value = p.get('name');
  if (p.get('tel'))     document.getElementById('c_tel').value = p.get('tel');
  if (p.get('email'))   document.getElementById('c_email').value = p.get('email');
  if (p.get('address')) document.getElementById('c_address').value = p.get('address');
  toggleRepairMenu();
};

// === éƒµä¾¿ç•ªå·â†’ä½æ‰€è‡ªå‹•å…¥åŠ›ï¼ˆZipCloud APIï¼‰ ===
function autoFillAddress(zip) {
  if (zip.length !== 7) return;
  fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + zip)
    .then(r => r.json())
    .then(data => {
      if (data.results && data.results[0]) {
        const r = data.results[0];
        document.getElementById('c_address').value = r.address1 + r.address2 + r.address3;
      }
    }).catch(() => {});
}

// === ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡æ›¿ ===
function toggleRepairMenu() {
  const isRepair = document.querySelector('input[name="order_type"][value="ä¿®ç†"]');
  document.getElementById('repair_options_area').style.display = (isRepair && isRepair.checked) ? 'block' : 'none';
}
document.querySelectorAll('input[name="order_type"]').forEach(el => {
  el.addEventListener('change', toggleRepairMenu);
});

// === ä¿®ç†ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ===
function changeCount(btn, delta) {
  const row = btn.closest('.repair-item-row');
  const span = row.querySelector('.count-num');
  let n = parseInt(span.textContent) + delta;
  if (n < 0) n = 0;
  span.textContent = n;
  row.classList.toggle('active', n > 0);
}

// === ã‚¯ãƒ¼ãƒãƒ³ ===
function applyCoupon() {
  const code = document.getElementById('c_coupon_code').value.trim().toLowerCase();
  const res = document.getElementById('coupon_result');
  if (code === 'ac2026') {
    couponApplied = true;
    res.textContent = 'ã‚¯ãƒ¼ãƒãƒ³é©ç”¨å®Œäº†ï¼š-3,000å††';
    res.className = 'coupon-success';
  } else {
    couponApplied = false;
    res.textContent = 'ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™';
    res.className = 'coupon-error';
  }
}

// === UIæ›´æ–° ===
function updateUI() {
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  document.getElementById('step' + currentStep).classList.add('active');
  for (let i = 1; i <= 7; i++) {
    const el = document.getElementById('p' + i);
    if (el) {
      el.className = 'progress-step';
      if (i < currentStep) el.classList.add('done');
      if (i === currentStep) el.classList.add('active');
    }
  }
  document.getElementById('btnBack').style.display = currentStep === 1 ? 'none' : 'block';
  const next = document.getElementById('btnNext');
  if (currentStep === 6) next.textContent = 'ä¸Šè¨˜ã«åŒæ„ã—ã¦é€ä¿¡';
  else if (currentStep === 7) document.querySelector('.bottom-nav').style.display = 'none';
  else next.textContent = 'æ¬¡ã¸';
}

// === ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ===
function clearFieldError(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('error');
}
function setFieldError(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('error');
  const errEl = el.querySelector('.error-msg');
  if (errEl) errEl.textContent = msg;
}

function validateStep(step) {
  let ok = true;
  if (step === 1) {
    ['f_name','f_kana','f_tel','f_email','f_zip','f_address','f_banchi','f_building'].forEach(clearFieldError);
    if (!document.getElementById('c_name').value.trim()) { setFieldError('f_name','ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); ok=false; }
    if (!document.getElementById('c_tel').value.trim()) { setFieldError('f_tel','é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); ok=false; }
    const email = document.getElementById('c_email').value.trim();
    if (!email || !email.includes('@')) { setFieldError('f_email','æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); ok=false; }
    if (!document.getElementById('c_address').value.trim()) { setFieldError('f_address','ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); ok=false; }
    if (!document.getElementById('c_banchi').value.trim()) { setFieldError('f_banchi','ç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); ok=false; }
  }
  if (step === 2) {
    ['f_equipment','f_symptom'].forEach(clearFieldError);
    if (!document.getElementById('c_equipment').value) { setFieldError('f_equipment','å¯¾è±¡æ©Ÿå™¨ã‚’é¸æŠã—ã¦ãã ã•ã„'); ok=false; }
    if (getSymptoms().length === 0) { setFieldError('f_symptom','ç—‡çŠ¶ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); ok=false; }
  }
  if (step === 6) {
    const a1 = document.getElementById('agree_contract').checked;
    const consentInput = document.getElementById('consent_text').value.trim();
    const a3 = document.getElementById('agree_privacy').checked;
    const sig = document.getElementById('c_signature').value.trim();
    const err = document.getElementById('agree_error');

    // é›»å­äº¤ä»˜ã®æ‰¿è«¾ï¼šå…¥åŠ›æ–‡ãŒãƒ•ãƒ¬ãƒ¼ã‚ºã¨ä¸€è‡´ã™ã‚‹ã‹ï¼ˆå…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ã—ã¦æ¯”è¼ƒï¼‰
    const normalize = s => s.replace(/[\sã€€]/g, '');
    const consentOK = normalize(consentInput) === normalize(CONSENT_PHRASE);

    if (!a1 || !consentOK || !a3 || !sig) {
      err.style.display = 'block';
      if (!consentOK && consentInput.length > 0) {
        err.textContent = 'é›»å­äº¤ä»˜ã®æ‰¿è«¾æ–‡ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
      } else {
        err.textContent = 'ã™ã¹ã¦ã®åŒæ„äº‹é …ã‚’æº€ãŸã—ã€ã”ç½²åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      }
      ok = false;
    } else {
      err.style.display = 'none';
    }
  }
  return ok;
}

// === ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===
function getSymptoms() { return Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(c=>c.value); }
function getOrderType() { return document.querySelector('input[name="order_type"]:checked').value; }
function getPaymentMethod() { return document.querySelector('input[name="payment_method"]:checked').value; }
function getSelectedRepairNames() {
  let items = [];
  document.querySelectorAll('.repair-item-row').forEach(row => {
    const cnt = parseInt(row.querySelector('.count-num').textContent);
    if (cnt > 0) items.push(row.dataset.name + ' x' + cnt);
  });
  return items.length ? items.join('ã€') : '';
}
function calculateRepairTotal() {
  let total = 0;
  document.querySelectorAll('.repair-item-row').forEach(row => {
    const cnt = parseInt(row.querySelector('.count-num').textContent);
    if (cnt > 0) total += parseInt(row.dataset.price) * cnt;
  });
  return total;
}

function getFormData() {
  const prefix = document.getElementById('c_case_prefix').value;
  const num = document.getElementById('c_case_num').value;
  return {
    case_id: num ? prefix + '-' + num : '',
    emp_id:    document.getElementById('c_emp_id').value,
    name:      document.getElementById('c_name').value,
    kana:      document.getElementById('c_kana').value,
    tel:       document.getElementById('c_tel').value,
    email:     document.getElementById('c_email').value,
    zip:       document.getElementById('c_zip').value,
    address:   document.getElementById('c_address').value,
    banchi:    document.getElementById('c_banchi').value,
    building:  document.getElementById('c_building').value,
    equipment: document.getElementById('c_equipment').value,
    maker:     '',
    symptoms:  getSymptoms(),
    detail:    document.getElementById('c_detail').value,
  };
}

// === ã‚¹ãƒ†ãƒƒãƒ—é€²è¡Œ ===
function nextStep() {
  if (!validateStep(currentStep)) return;

  // Step3 â†’ Step4ï¼ˆç¢ºèªç”»é¢ç”Ÿæˆï¼‰
  if (currentStep === 3) {
    const d = getFormData();
    const sym = d.symptoms.length ? d.symptoms.join('ã€') : 'ï¼ˆé¸æŠãªã—ï¼‰';
    const oType = getOrderType();
    const pay = getPaymentMethod();
    let repairDetail = '';
    if (oType === 'ä¿®ç†') repairDetail = '<br><span style="font-size:.85rem;color:#666">â”” ' + getSelectedRepairNames() + '</span>';
    let discountMsg = couponApplied ? '<br><span style="color:#e65100;font-weight:bold">â€»ã‚¯ãƒ¼ãƒãƒ³é©ç”¨ï¼š-3,000å††</span>' : '';

    document.getElementById('confirmContent').innerHTML = `
      <div class="confirm-row"><span class="confirm-label">ãŠåå‰</span><span class="confirm-val">${d.name}ï¼ˆ${d.kana}ï¼‰</span></div>
      <div class="confirm-row"><span class="confirm-label">é›»è©±ç•ªå·</span><span class="confirm-val">${d.tel}</span></div>
      <div class="confirm-row"><span class="confirm-label">ãƒ¡ãƒ¼ãƒ«</span><span class="confirm-val">${d.email}</span></div>
      <div class="confirm-row"><span class="confirm-label">ä½æ‰€</span><span class="confirm-val">ã€’${d.zip}<br>${d.address} ${d.banchi} ${d.building}</span></div>
      <div class="confirm-row"><span class="confirm-label">æ©Ÿå™¨</span><span class="confirm-val">${d.equipment || 'æœªé¸æŠ'}</span></div>
      <div class="confirm-row"><span class="confirm-label">ç—‡çŠ¶</span><span class="confirm-val">${sym}</span></div>
      <div class="confirm-row"><span class="confirm-label">ä½œæ¥­</span><span class="confirm-val" style="color:var(--blue)">${oType} ${repairDetail} ${discountMsg}</span></div>
      <div class="confirm-row"><span class="confirm-label">æ”¯æ‰•ã„</span><span class="confirm-val">${pay}</span></div>
    `;
  }

  // Step4 â†’ Step5ï¼ˆè¦‹ç©æ›¸è¡¨ç¤ºï¼‰
  if (currentStep === 4) {
    const orderType = getOrderType();
    const equip = document.getElementById('c_equipment').value;
    const feeLabel = document.getElementById('fee_label');
    let totalAmount = 0;
    let estRows = '';

    if (orderType === 'åŸå› ç©¶æ˜ä½œæ¥­') {
      feeLabel.textContent = 'æ•…éšœè¨ºæ–­è²»ç”¨ï¼ˆç¨è¾¼ï¼‰';
      const diagFee = equip.includes('æ¥­å‹™ç”¨') ? 16500 : 9900;
      totalAmount = diagFee;
      estRows = '<tr><td style="padding:8px;border-bottom:1px solid #ddd">æ•…éšœè¨ºæ–­ï¼ˆ' + (equip || 'ãƒ«ãƒ¼ãƒ ã‚¨ã‚¢ã‚³ãƒ³') + 'ï¼‰</td>'
        + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd">' + diagFee.toLocaleString() + 'å††</td>'
        + '<td style="padding:8px;text-align:center;border-bottom:1px solid #ddd">1</td>'
        + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd">' + diagFee.toLocaleString() + 'å††</td></tr>';
    } else {
      feeLabel.textContent = 'ä¿®ç†ä½œæ¥­è²»ç”¨ï¼ˆç›®å®‰ãƒ»ç¨è¾¼ï¼‰';
      document.querySelectorAll('.repair-item-row').forEach(row => {
        const cnt = parseInt(row.querySelector('.count-num').textContent);
        if (cnt > 0) {
          const price = parseInt(row.dataset.price);
          const sub = price * cnt;
          totalAmount += sub;
          estRows += '<tr><td style="padding:8px;border-bottom:1px solid #ddd">' + row.dataset.name + '</td>'
            + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd">' + price.toLocaleString() + 'å††</td>'
            + '<td style="padding:8px;text-align:center;border-bottom:1px solid #ddd">' + cnt + '</td>'
            + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd">' + sub.toLocaleString() + 'å††</td></tr>';
        }
      });
    }

    if (couponApplied) {
      estRows += '<tr><td style="padding:8px;border-bottom:1px solid #ddd;color:#e65100">ã‚¯ãƒ¼ãƒãƒ³å‰²å¼•</td>'
        + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd;color:#e65100">-3,000å††</td>'
        + '<td style="padding:8px;text-align:center;border-bottom:1px solid #ddd">1</td>'
        + '<td style="padding:8px;text-align:right;border-bottom:1px solid #ddd;color:#e65100">-3,000å††</td></tr>';
      totalAmount -= 3000;
      if (totalAmount < 0) totalAmount = 0;
    }

    document.getElementById('est_customer_name').textContent = document.getElementById('c_name').value + ' æ§˜';
    document.getElementById('est_date').textContent = 'ç™ºè¡Œæ—¥ï¼š' + new Date().toLocaleDateString('ja-JP');
    document.getElementById('est_items_body').innerHTML = estRows;
    document.getElementById('est_total').textContent = 'Â¥' + totalAmount.toLocaleString();
    document.getElementById('fee_diagnosis').value = totalAmount.toLocaleString('ja-JP');
  }

  // Step6 â†’ é€ä¿¡
  if (currentStep === 6) {
    doSubmit();
    return;
  }

  currentStep++;
  updateUI();
}

function prevStep() {
  if (currentStep > 1) { currentStep--; updateUI(); }
}

// === GASã¸é€ä¿¡ ===
async function doSubmit() {
  if (GAS_API_URL.includes('ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ID')) {
    alert('ã€é‡è¦ã€‘GASã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Code.gsã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦URLã‚’è²¼ã£ã¦ãã ã•ã„ã€‚');
    return;
  }
  const btn = document.getElementById('btnNext');
  btn.disabled = true;
  btn.textContent = 'å‡¦ç†ä¸­...';

  const d = getFormData();
  let orderInfo = getOrderType();
  if (orderInfo === 'ä¿®ç†') orderInfo += 'ï¼š' + getSelectedRepairNames();
  if (couponApplied) orderInfo += ' ã€ã‚¯ãƒ¼ãƒãƒ³åˆ©ç”¨(ac2026)ã€‘';
  if (document.getElementById('req_sameday').checked) orderInfo += ' ã€å½“æ—¥å·¥äº‹å¸Œæœ›ã€‘';

  const payload = {
    ...d,
    services: d.symptoms,
    order_type: orderInfo,
    payment_method: getPaymentMethod(),
    fee_diagnosis: document.getElementById('fee_diagnosis').value.replace(/,/g, ''),
    cancel_rule: document.getElementById('cancel_rule').value,
    agree_contract: true,
    agree_electronic: true,
    consent_text: document.getElementById('consent_text').value.trim(),
    agree_privacy: true,
    signature: document.getElementById('c_signature').value
  };

  try {
    // GAS Webã‚¢ãƒ—ãƒªã¯CORSåˆ¶ç´„ã‚ã‚Šã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¸è¦ãªã®ã§ãã®ã¾ã¾é€ã‚‹
    await fetch(GAS_API_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
  } catch(e) {
    console.log('é€ä¿¡å®Œäº†ï¼ˆno-cors fallbackï¼‰');
  }

  currentStep = 7;
  updateUI();
}
</script>
</body>
</html>
