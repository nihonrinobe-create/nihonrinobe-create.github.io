<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¥­å‹™å ±å‘Š</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#0055a4; --blue-dark:#003d7a; --blue-light:#e8f2fc;
  --green:#2e7d32; --green-light:#e8f5e9; --red:#c62828;
  --bg:#f5f7fa; --card:#fff; --text:#1a1a1a; --text-sub:#5f6368;
  --border:#dce1e8; --radius:14px;
  --orange:#e65100; --orange-bg:#fff3e0;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;padding-bottom:100px}
.hero{background:linear-gradient(160deg,var(--green),#1b5e20);color:#fff;padding:24px 20px;text-align:center}
.hero h1{font-size:1.4rem;font-weight:700}
.hero .case-info{font-size:.9rem;opacity:.9;margin-top:6px}
.container{max-width:500px;margin:0 auto;padding:15px 20px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.06);padding:18px;margin-bottom:14px;border:1px solid var(--border)}
.card-title{font-weight:700;color:var(--blue);margin-bottom:12px;display:flex;align-items:center;gap:8px;font-size:1rem}
.section-title{font-weight:700;font-size:.95rem;margin:16px 0 10px;padding:8px 12px;background:var(--blue-light);border-radius:8px;color:var(--blue)}

/* å¥‘ç´„çŠ¶æ³ã‚°ãƒªãƒƒãƒ‰ */
.status-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
.status-label{border:2px solid var(--border);border-radius:10px;padding:14px 8px;text-align:center;font-size:.9rem;font-weight:700;cursor:pointer;background:#fff;transition:all .2s}
.status-label input{display:none}
.status-label .icon{font-size:1.3rem;display:block;margin-bottom:4px}
.status-label:has(input:checked){border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.status-label.loss:has(input:checked){border-color:var(--red);background:#ffebee;color:var(--red)}
.status-label.cancel:has(input:checked){border-color:#666;background:#eee;color:#333}
.status-label.reserve:has(input:checked){border-color:var(--orange);background:var(--orange-bg);color:var(--orange)}

/* ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.repair-item{display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:6px}
.repair-item.active{border-color:var(--blue);box-shadow:0 0 0 1px var(--blue) inset}
.repair-name{font-size:.9rem;font-weight:500;flex:1}
.repair-price-tag{font-size:.8rem;color:var(--text-sub);display:block}
.counter{display:flex;align-items:center;gap:8px}
.counter button{width:30px;height:30px;border-radius:50%;border:none;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.counter .minus{background:#eee;color:#555}
.counter .plus{background:var(--blue);color:#fff}
.counter .num{font-weight:700;width:20px;text-align:center}

/* åˆè¨ˆã‚¨ãƒªã‚¢ */
.total-box{background:var(--green-light);border:2px solid var(--green);border-radius:12px;padding:16px;text-align:center;margin:12px 0}
.total-label{font-size:.9rem;color:var(--green);font-weight:600}
.total-amount{font-size:1.8rem;font-weight:800;color:var(--green)}

/* è¦‹ç©ã‚Šãƒˆã‚°ãƒ« */
.toggle-box{background:var(--orange-bg);border:1px solid #ffcc80;border-radius:10px;padding:14px;margin:14px 0}
.toggle-label{display:flex;gap:10px;align-items:center;cursor:pointer;font-weight:700;color:var(--orange)}
.toggle-label input{transform:scale(1.3)}
#estimate_area{display:none;margin-top:12px}
.estimate-total-box{background:#fff3e0;border:2px solid var(--orange);border-radius:12px;padding:16px;text-align:center;margin:12px 0}
.estimate-total-label{font-size:.9rem;color:var(--orange);font-weight:600}
.estimate-total-amount{font-size:1.6rem;font-weight:800;color:var(--orange)}

/* æ”¯æ‰•ã„ */
.pay-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin:10px 0}
.pay-label{border:2px solid var(--border);border-radius:10px;padding:10px 5px;text-align:center;font-size:.9rem;font-weight:600;cursor:pointer;background:#fff}
.pay-label input{display:none}
.pay-label:has(input:checked){border-color:var(--blue);background:var(--blue-light);color:var(--blue)}

/* ãƒœã‚¿ãƒ³ */
.btn-submit{display:block;width:100%;padding:16px;border-radius:12px;border:none;font-size:1.1rem;font-weight:700;cursor:pointer;margin-top:12px}
.btn-primary{background:var(--green);color:#fff}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-loss{background:var(--red);color:#fff}
.btn-cancel{background:#666;color:#fff}
.btn-reserve{background:var(--orange);color:#fff}

/* å¾Œæ—¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç™ºè¡Œ */
.doc-section{margin-top:20px}
.doc-btn-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.doc-btn{padding:12px;border-radius:10px;border:2px solid var(--border);background:#fff;font-weight:700;font-size:.85rem;cursor:pointer;text-align:center}
.doc-btn:hover{border-color:var(--blue);background:var(--blue-light)}
.doc-btn.done{border-color:var(--green);background:var(--green-light);color:var(--green)}

.field{margin-bottom:14px}
.field label{display:block;font-weight:600;font-size:.9rem;margin-bottom:5px}
.field input,.field textarea,.field select{width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:1rem;background:#fff}
.field-hint{font-size:.75rem;color:var(--text-sub);margin-top:4px}
.field-required{color:var(--red);font-size:.8rem}
.complete-msg{text-align:center;padding:30px 20px;font-size:1.1rem}
.hidden{display:none}

/* å¤±æ³¨ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.status-notice{padding:16px;border-radius:10px;margin:14px 0;text-align:center;font-weight:600;font-size:.95rem}
.status-notice.loss-notice{background:#ffebee;border:2px solid var(--red);color:var(--red)}
.status-notice.cancel-notice{background:#eee;border:2px solid #999;color:#555}
.status-notice.reserve-notice{background:var(--orange-bg);border:2px solid var(--orange);color:var(--orange)}
</style>
</head>
<body>

<div class="hero">
  <h1>ğŸ“‹ æ¥­å‹™å ±å‘Š</h1>
  <div class="case-info">
    æ¡ˆä»¶ç•ªå·: <span id="h_case_id">---</span> ï¼ <span id="h_name">---</span> æ§˜
  </div>
</div>

<div class="container">

  <!-- ===== ãƒ¡ã‚¤ãƒ³ç”»é¢ ===== -->
  <div id="main_view">

    <!-- æ‹…å½“è€…ç•ªå· -->
    <div class="card">
      <div class="card-title">ğŸ‘¤ å ±å‘Šè€…æƒ…å ±</div>
      <div class="field">
        <label>æ‹…å½“è€…ç•ªå· <span class="field-required">â€»å¿…é ˆ</span></label>
        <input type="text" id="staff_id" placeholder="ä¾‹ï¼š0001" inputmode="numeric">
      </div>
      <div class="field">
        <label>è¨ªå•æ—¥</label>
        <input type="date" id="visit_date">
      </div>
    </div>

    <!-- å¥‘ç´„çŠ¶æ³ -->
    <div class="section-title">ğŸ“Š å¥‘ç´„çŠ¶æ³</div>
    <div class="card">
      <div class="status-grid">
        <label class="status-label" onclick="onStatusChange()">
          <input type="radio" name="contract_status" value="å®Œå·¥" checked>
          <span class="icon">âœ…</span>å®Œå·¥
        </label>
        <label class="status-label loss" onclick="onStatusChange()">
          <input type="radio" name="contract_status" value="å¤±æ³¨">
          <span class="icon">âŒ</span>å¤±æ³¨
        </label>
        <label class="status-label reserve" onclick="onStatusChange()">
          <input type="radio" name="contract_status" value="äºˆç´„ï¼ˆè¦‹ç©ã‚ã‚Šï¼‰">
          <span class="icon">ğŸ“„</span>äºˆç´„<br><small>è¦‹ç©ã‚ã‚Š</small>
        </label>
        <label class="status-label reserve" onclick="onStatusChange()">
          <input type="radio" name="contract_status" value="äºˆç´„ï¼ˆè¦‹ç©ãªã—ï¼‰">
          <span class="icon">ğŸ“…</span>äºˆç´„<br><small>è¦‹ç©ãªã—</small>
        </label>
        <label class="status-label cancel" onclick="onStatusChange()">
          <input type="radio" name="contract_status" value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
          <span class="icon">ğŸš«</span>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </label>
      </div>
    </div>

    <!-- å¤±æ³¨ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®é€šçŸ¥ -->
    <div id="notice_loss" class="status-notice loss-notice hidden">
      å£²ä¸Š Â¥0 ã§å ±å‘Šã—ã¾ã™ï¼ˆåºƒå‘Šè²»ã¯è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰
    </div>
    <div id="notice_cancel" class="status-notice cancel-notice hidden">
      ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ã—ã¦å ±å‘Šã—ã¾ã™ï¼ˆåºƒå‘Šè²»ã¯è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰
    </div>
    <div id="notice_reserve_est" class="status-notice reserve-notice hidden">
      äºˆç´„ã¨ã—ã¦è¨˜éŒ²ã—ã€è¦‹ç©æ›¸ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä»˜ã—ã¾ã™
    </div>
    <div id="notice_reserve_no" class="status-notice reserve-notice hidden">
      äºˆç´„ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ï¼ˆå¾Œè¿½ã„ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾è±¡ã«ãªã‚Šã¾ã™ï¼‰
    </div>

    <!-- ===== å®Œå·¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
    <div id="section_kankou">

      <!-- ä»Šæ—¥ã®ä½œæ¥­ -->
      <div class="section-title">ğŸ’° ä»Šæ—¥ã®è²»ç”¨</div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee">
          <span style="font-weight:600">æ•…éšœè¨ºæ–­è²»</span>
          <span style="font-weight:700;color:var(--blue)" id="diag_fee_display">Â¥9,900</span>
        </div>
      </div>

      <div class="section-title">ğŸ”§ ä»Šæ—¥ã‚„ã£ãŸè¿½åŠ ä½œæ¥­</div>
      <div class="card" id="today_repairs">
        <!-- JSã§ç”Ÿæˆ -->
      </div>

      <div class="total-box">
        <div class="total-label">ä»Šæ—¥ã®ãŠæ”¯æ‰•ã„åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div>
        <div class="total-amount" id="today_total">Â¥9,900</div>
      </div>

      <div class="card">
        <div class="field">
          <label>ãŠæ”¯æ‰•ã„æ–¹æ³•</label>
          <div class="pay-grid">
            <label class="pay-label"><input type="radio" name="payment" value="ç¾é‡‘" checked>ç¾é‡‘</label>
            <label class="pay-label"><input type="radio" name="payment" value="ã‚«ãƒ¼ãƒ‰">ã‚«ãƒ¼ãƒ‰</label>
            <label class="pay-label"><input type="radio" name="payment" value="æŒ¯è¾¼">æŒ¯è¾¼</label>
            <label class="pay-label"><input type="radio" name="payment" value="å¾Œæ—¥è«‹æ±‚">å¾Œæ—¥è«‹æ±‚</label>
          </div>
          <div id="est_transfer_deadline_area" style="display:none;margin-top:10px">
            <label style="font-size:.85rem;font-weight:600">æŒ¯è¾¼æœŸé™</label>
            <input type="date" id="est_transfer_deadline" style="width:100%;padding:10px;border:2px solid #d9dee4;border-radius:8px;font-size:1rem;margin-top:4px">
          </div>
        </div>
      </div>

      <!-- å¾Œæ—¥è¦‹ç©ã‚Šï¼ˆå®Œå·¥æ™‚ã«ã‚‚ä½¿ãˆã‚‹ï¼‰ -->
      <div class="toggle-box" id="toggle_estimate_box">
        <label class="toggle-label">
          <input type="checkbox" id="chk_estimate" onchange="toggleEstimate()">
          <span>å¾Œæ—¥åˆ†ã®è¦‹ç©æ›¸ã‚‚ä½œæˆã™ã‚‹</span>
        </label>
        <div id="estimate_area">
          <div class="field" style="margin-top:10px">
            <label>è¦‹ç©ã‚Šæœ‰åŠ¹æœŸé™</label>
            <input type="date" id="est_expiry">
          </div>
          <div class="field">
            <label>è¦‹ç©ã‚Šå‚™è€ƒ</label>
            <textarea id="est_note" rows="2" placeholder="ä¾‹ï¼šå®¤å¤–æ©Ÿã®åŸºæ¿äº¤æ›ãŒå¿…è¦ã€‚éƒ¨å“å–å¯„ã›1é€±é–“ã€‚"></textarea>
          </div>
          <div id="estimate_repairs">
            <!-- JSã§ç”Ÿæˆ -->
          </div>
          <div class="estimate-total-box">
            <div class="estimate-total-label">è¦‹ç©ã‚Šåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div>
            <div class="estimate-total-amount" id="est_total">Â¥0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== äºˆç´„ï¼ˆè¦‹ç©ã‚ã‚Šï¼‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ===== -->
    <div id="section_reserve_est" class="hidden">
      <div class="section-title">ğŸ“„ è¦‹ç©æ›¸ã®ä½œæˆ</div>
      <div class="card">
        <div class="field">
          <label>è¦‹ç©ã‚Šæœ‰åŠ¹æœŸé™</label>
          <input type="date" id="res_est_expiry">
        </div>
        <div class="field">
          <label>è¦‹ç©ã‚Šå‚™è€ƒ</label>
          <textarea id="res_est_note" rows="2" placeholder="ä¾‹ï¼šå®¤å¤–æ©Ÿã®åŸºæ¿äº¤æ›ãŒå¿…è¦ã€‚éƒ¨å“å–å¯„ã›1é€±é–“ã€‚"></textarea>
        </div>
      </div>
      <div id="reserve_est_repairs">
        <!-- JSã§ç”Ÿæˆ -->
      </div>
      <div class="estimate-total-box">
        <div class="estimate-total-label">è¦‹ç©ã‚Šåˆè¨ˆï¼ˆç¨è¾¼ï¼‰</div>
        <div class="estimate-total-amount" id="res_est_total">Â¥0</div>
      </div>
    </div>

    <!-- å¤±æ³¨ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± -->
    <div id="section_reason" class="hidden">
      <div class="card">
        <div class="field">
          <label>ç†ç”±ãƒ»å‚™è€ƒ</label>
          <textarea id="loss_reason" rows="3" placeholder="å¤±æ³¨ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›"></textarea>
        </div>
      </div>
    </div>

    <!-- å…±é€šãƒ¡ãƒ¢ -->
    <div class="card">
      <div class="field">
        <label>æ‹…å½“è€…ãƒ¡ãƒ¢ï¼ˆç¤¾å†…ç”¨ï¼‰</label>
        <textarea id="staff_memo" rows="2" placeholder="ç¾å ´ã®çŠ¶æ³ãƒ»ãŠå®¢æ§˜ã¸ã®èª¬æ˜å†…å®¹ãªã©"></textarea>
      </div>
    </div>

    <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
    <button class="btn-submit btn-primary" id="btn_submit" onclick="submitReport()">
      å ±å‘Šã‚’é€ä¿¡
    </button>
    <div class="field-hint" style="text-align:center;margin-top:8px" id="submit_hint">
      â€»é€ä¿¡å¾Œã€å£²ä¸Šç®¡ç†ã‚·ãƒ¼ãƒˆã«è‡ªå‹•è¨˜éŒ²ã•ã‚Œã¾ã™
    </div>
  </div>

  <!-- ===== é€ä¿¡å®Œäº†ç”»é¢ ===== -->
  <div id="done_view" class="hidden">
    <div class="complete-msg" id="done_msg">
      âœ… å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸ
    </div>

    <!-- å¾Œæ—¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç™ºè¡Œ -->
    <div class="doc-section" id="doc_section">
      <div class="section-title">ğŸ“„ æ›¸é¡ç™ºè¡Œï¼ˆå¾Œæ—¥ç”¨ï¼‰</div>
      <div class="card">
        <p style="font-size:.85rem;color:var(--text-sub);margin-bottom:10px">
          è¦‹ç©ã‚ŠãŒæ‰¿èªã•ã‚ŒãŸã‚‰ã€ã“ã“ã‹ã‚‰è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ã‚’ç™ºè¡Œã§ãã¾ã™ã€‚
        </p>
        <div class="doc-btn-grid">
          <button class="doc-btn" id="btn_invoice" onclick="generateDoc('invoice')">
            ğŸ“‘ è«‹æ±‚æ›¸ã‚’ç™ºè¡Œ
          </button>
          <button class="doc-btn" id="btn_receipt" onclick="generateDoc('receipt')">
            ğŸ§¾ é ˜åæ›¸ã‚’ç™ºè¡Œ
          </button>
        </div>
        <div class="field-hint" style="margin-top:10px">
          â€»è«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ã¯ç™ºè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãŠå®¢æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚
        </div>
        <div id="doc_result" style="margin-top:10px;font-weight:700"></div>
      </div>
    </div>
  </div>

</div>

<script>
// ================================
// â˜… GAS Webã‚¢ãƒ—ãƒªã®URLã‚’ã“ã“ã«è²¼ã‚‹ â˜…
// ================================
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwGxE0VcPv6SAL14PGpm0_a_TTIrudeuq8NE27LVQmdYMA_zIaGG1lcNg0u-y6FsfK77A/exec';

// === ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼å®šç¾© ===
const REPAIR_MENU = [
  { name: 'å†·åª’ã‚¬ã‚¹æ³¨å…¥ï¼ˆ500gã¾ã§ï¼‰', price: 29700 },
  { name: 'å†·åª’ã‚¬ã‚¹è¿½åŠ ï¼ˆ100gï¼‰', price: 3300 },
  { name: 'çœŸç©ºå¼•ã', price: 17600 },
  { name: 'ãƒ•ãƒ¬ã‚¢åŠ å·¥ãƒ»ãƒãƒ«ãƒ–ã‚³ã‚¢äº¤æ›', price: 17600 },
  { name: 'æ°´æ¼ã‚Œä¿®å¾©', price: 28600 },
  { name: 'å››æ–¹å¼å‹•ä½œä¸è‰¯è§£æ¶ˆ', price: 26400 },
  { name: 'é›»æºéƒ¨å†æ¥ç¶š', price: 26400 },
  { name: 'ã‚¨ã‚¢ã‚³ãƒ³æ¨™æº–å–ä»˜', price: 28600 },
  { name: 'ã‚¨ã‚¢ã‚³ãƒ³å–ã‚Šå¤–ã—', price: 8800 },
  { name: 'ç©´é–‹ã‘å·¥äº‹', price: 26400 },
];

// === URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±å–å¾— ===
const params = new URLSearchParams(location.search);
const P = {
  case_id:     params.get('case_id') || params.get('c') || '',
  name:        params.get('name') || '',
  email:       params.get('email') || '',
  tel:         params.get('tel') || '',
  address:     params.get('address') || '',
  initial_fee: parseInt(params.get('initial_fee')) || 9900,
  equipment:   params.get('equipment') || '',
  staff_id:    params.get('staff_id') || '',
};

// UIåˆæœŸåŒ–é–¢æ•°
function initUI() {
  document.getElementById('h_case_id').textContent = P.case_id || 'æœªè¨­å®š';
  document.getElementById('h_name').textContent = P.name || 'æœªè¨­å®š';
  document.getElementById('diag_fee_display').textContent = 'Â¥' + P.initial_fee.toLocaleString();
  document.getElementById('today_total').textContent = 'Â¥' + P.initial_fee.toLocaleString();
  if (P.staff_id) {
    let sid = String(P.staff_id);
    while (sid.length > 0 && sid.length < 4) sid = '0' + sid;
    document.getElementById('staff_id').value = sid;
  }
}

// çŸ­ç¸®URL: ?c=CASE_ID ã®ã¿ã®å ´åˆã€GASã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
(async function() {
  if (P.case_id && !params.get('name') && !params.get('initial_fee')) {
    try {
      document.getElementById('h_case_id').textContent = P.case_id + 'ï¼ˆèª­è¾¼ä¸­...ï¼‰';
      const resp = await fetch(GAS_API_URL, {
        method: 'POST', body: JSON.stringify({ form_type: 'lookup', case_id: P.case_id })
      });
      const r = await resp.json();
      if (r.ok) {
        P.name = r.name || P.name;
        P.email = r.email || P.email;
        P.tel = r.tel || P.tel;
        P.address = (r.address||'') + ' ' + (r.banchi||'');
        P.equipment = r.equipment || P.equipment;
        P.initial_fee = parseInt(r.initial_fee) || P.initial_fee;
        P.staff_id = r.staff_id || P.staff_id;
        // æŒ¯è¾¼ã®å ´åˆã€æ”¯æ‰•ã„æ–¹æ³•ã‚’è‡ªå‹•è¨­å®š
        if (r.payment_method === 'æŒ¯è¾¼') {
          const radios = document.querySelectorAll('input[name="payment"]');
          radios.forEach(rb => {
            if (rb.value === 'æŒ¯è¾¼') {
              rb.checked = true;
              rb.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
          // changeã‚¤ãƒ™ãƒ³ãƒˆã§14æ—¥å¾ŒãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãŒã€æ¡ˆä»¶å°å¸³ã®å€¤ãŒã‚ã‚Œã°ä¸Šæ›¸ã
          if (r.transfer_deadline) {
            document.getElementById('est_transfer_deadline').value = r.transfer_deadline;
          }
        }
      }
    } catch(e) { console.log('lookup error', e); }
  }
  initUI();
})();

// è¨ªå•æ—¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šä»Šæ—¥
document.getElementById('visit_date').value = new Date().toISOString().split('T')[0];

// è¦‹ç©ã‚Šæœ‰åŠ¹æœŸé™ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ30æ—¥å¾Œï¼‰
const d30 = new Date(); d30.setDate(d30.getDate() + 30);
document.getElementById('est_expiry').value = d30.toISOString().split('T')[0];
document.getElementById('res_est_expiry').value = d30.toISOString().split('T')[0];

// === ä¿®ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼HTMLç”Ÿæˆ ===
function buildRepairMenu(containerId, prefix) {
  const container = document.getElementById(containerId);
  container.innerHTML = REPAIR_MENU.map((item, i) => `
    <div class="repair-item" id="${prefix}_row_${i}" data-price="${item.price}">
      <div>
        <div class="repair-name">${item.name}</div>
        <span class="repair-price-tag">Â¥${item.price.toLocaleString()}</span>
      </div>
      <div class="counter">
        <button class="minus" onclick="changeQty('${prefix}',${i},-1)">-</button>
        <span class="num" id="${prefix}_qty_${i}">0</span>
        <button class="plus" onclick="changeQty('${prefix}',${i},1)">+</button>
      </div>
    </div>
  `).join('');
}
buildRepairMenu('today_repairs', 'today');
buildRepairMenu('estimate_repairs', 'est');
buildRepairMenu('reserve_est_repairs', 'resest');

// === æ•°é‡å¤‰æ›´ ===
function changeQty(prefix, idx, delta) {
  const span = document.getElementById(prefix + '_qty_' + idx);
  let n = parseInt(span.textContent) + delta;
  if (n < 0) n = 0;
  span.textContent = n;
  const row = document.getElementById(prefix + '_row_' + idx);
  row.classList.toggle('active', n > 0);
  recalc();
}

// === åˆè¨ˆå†è¨ˆç®— ===
function recalc() {
  let todayRepair = 0;
  REPAIR_MENU.forEach((item, i) => {
    const qty = parseInt(document.getElementById('today_qty_' + i).textContent);
    todayRepair += item.price * qty;
  });
  const todayTotal = P.initial_fee + todayRepair;
  document.getElementById('today_total').textContent = 'Â¥' + todayTotal.toLocaleString();

  let estTotal = 0;
  REPAIR_MENU.forEach((item, i) => {
    const qty = parseInt(document.getElementById('est_qty_' + i).textContent);
    estTotal += item.price * qty;
  });
  document.getElementById('est_total').textContent = 'Â¥' + estTotal.toLocaleString();

  let resEstTotal = 0;
  REPAIR_MENU.forEach((item, i) => {
    const qty = parseInt(document.getElementById('resest_qty_' + i).textContent);
    resEstTotal += item.price * qty;
  });
  document.getElementById('res_est_total').textContent = 'Â¥' + resEstTotal.toLocaleString();
}

// === è¦‹ç©ã‚Šãƒˆã‚°ãƒ« ===
function toggleEstimate() {
  document.getElementById('estimate_area').style.display =
    document.getElementById('chk_estimate').checked ? 'block' : 'none';
}

// === æŒ¯è¾¼æœŸé™ã®è¡¨ç¤ºåˆ‡æ›¿ ===
document.querySelectorAll('input[name="payment"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const area = document.getElementById('est_transfer_deadline_area');
    if (document.querySelector('input[name="payment"]:checked').value === 'æŒ¯è¾¼') {
      area.style.display = 'block';
      if (!document.getElementById('est_transfer_deadline').value) {
        const d14 = new Date(); d14.setDate(d14.getDate() + 14);
        document.getElementById('est_transfer_deadline').value = d14.toISOString().split('T')[0];
      }
    } else { area.style.display = 'none'; }
  });
});

// === å¥‘ç´„çŠ¶æ³ã®åˆ‡æ›¿ ===
function onStatusChange() {
  setTimeout(() => {
    const status = document.querySelector('input[name="contract_status"]:checked').value;
    const isKankou = (status === 'å®Œå·¥');
    const isLoss = (status === 'å¤±æ³¨');
    const isCancel = (status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    const isReserveEst = (status === 'äºˆç´„ï¼ˆè¦‹ç©ã‚ã‚Šï¼‰');
    const isReserveNo = (status === 'äºˆç´„ï¼ˆè¦‹ç©ãªã—ï¼‰');

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('section_kankou').classList.toggle('hidden', !isKankou);
    document.getElementById('section_reserve_est').classList.toggle('hidden', !isReserveEst);
    document.getElementById('section_reason').classList.toggle('hidden', !(isLoss || isCancel));

    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    document.getElementById('notice_loss').classList.toggle('hidden', !isLoss);
    document.getElementById('notice_cancel').classList.toggle('hidden', !isCancel);
    document.getElementById('notice_reserve_est').classList.toggle('hidden', !isReserveEst);
    document.getElementById('notice_reserve_no').classList.toggle('hidden', !isReserveNo);

    // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®
    const btn = document.getElementById('btn_submit');
    btn.className = 'btn-submit';
    if (isKankou) { btn.classList.add('btn-primary'); btn.textContent = 'å®Œäº†å ±å‘Šã‚’é€ä¿¡'; }
    else if (isLoss) { btn.classList.add('btn-loss'); btn.textContent = 'å¤±æ³¨ã¨ã—ã¦å ±å‘Š'; }
    else if (isCancel) { btn.classList.add('btn-cancel'); btn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ã—ã¦å ±å‘Š'; }
    else if (isReserveEst) { btn.classList.add('btn-reserve'); btn.textContent = 'äºˆç´„ï¼‹è¦‹ç©æ›¸ã‚’é€ä¿¡'; }
    else if (isReserveNo) { btn.classList.add('btn-reserve'); btn.textContent = 'äºˆç´„ã¨ã—ã¦å ±å‘Š'; }
  }, 10);
}

// === é¸æŠã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾— ===
function getSelectedItems(prefix) {
  const items = [];
  REPAIR_MENU.forEach((item, i) => {
    const qty = parseInt(document.getElementById(prefix + '_qty_' + i).textContent);
    if (qty > 0) items.push({ name: item.name, price: item.price, qty: qty, subtotal: item.price * qty });
  });
  return items;
}

// === é€ä¿¡ ===
async function submitReport() {
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šæ‹…å½“è€…ç•ªå·å¿…é ˆ
  let staffId = document.getElementById('staff_id').value.trim();
  if (!staffId) {
    alert('æ‹…å½“è€…ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    document.getElementById('staff_id').focus();
    return;
  }
  // 0åŸ‹ã‚4æ¡ã«çµ±ä¸€
  while (staffId.length > 0 && staffId.length < 4) staffId = '0' + staffId;

  const btn = document.getElementById('btn_submit');
  btn.disabled = true;
  btn.textContent = 'é€ä¿¡ä¸­...';

  const status = document.querySelector('input[name="contract_status"]:checked').value;
  const isKankou = (status === 'å®Œå·¥');
  const isReserveEst = (status === 'äºˆç´„ï¼ˆè¦‹ç©ã‚ã‚Šï¼‰');

  // ä»Šæ—¥ã®ä½œæ¥­ãƒ‡ãƒ¼ã‚¿
  const todayItems = isKankou ? getSelectedItems('today') : [];
  let todayRepairTotal = 0;
  todayItems.forEach(it => todayRepairTotal += it.subtotal);

  // è¦‹ç©æ›¸ãƒ‡ãƒ¼ã‚¿
  let hasEstimate = false;
  let estItems = [];
  let estTotal = 0;
  let estExpiry = '';
  let estNote = '';

  if (isKankou && document.getElementById('chk_estimate').checked) {
    hasEstimate = true;
    estItems = getSelectedItems('est');
    estItems.forEach(it => estTotal += it.subtotal);
    estExpiry = document.getElementById('est_expiry').value;
    estNote = document.getElementById('est_note').value;
  } else if (isReserveEst) {
    hasEstimate = true;
    estItems = getSelectedItems('resest');
    estItems.forEach(it => estTotal += it.subtotal);
    estExpiry = document.getElementById('res_est_expiry').value;
    estNote = document.getElementById('res_est_note').value;
  }

  const payload = {
    form_type: 'estimate',
    contract_status: status,
    case_id: P.case_id,
    name: P.name,
    email: P.email,
    tel: P.tel,
    address: P.address,
    equipment: P.equipment,
    staff_id: staffId,
    visit_date: document.getElementById('visit_date').value,

    // ä»Šæ—¥ã®åˆ†ï¼ˆå®Œå·¥æ™‚ã®ã¿æœ‰åŠ¹ï¼‰
    diag_fee: isKankou ? P.initial_fee : 0,
    today_repairs: todayItems,
    today_repair_total: todayRepairTotal,
    today_total: isKankou ? (P.initial_fee + todayRepairTotal) : 0,
    payment_method: isKankou ? document.querySelector('input[name="payment"]:checked').value : '',
    transfer_deadline: (() => {
      if (!isKankou || document.querySelector('input[name="payment"]:checked').value !== 'æŒ¯è¾¼') return '';
      const v = document.getElementById('est_transfer_deadline').value;
      if (v) return v;
      // ç©ºãªã‚‰14æ—¥å¾Œã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const d14 = new Date(); d14.setDate(d14.getDate() + 14);
      return d14.toISOString().split('T')[0];
    })(),

    // è¦‹ç©ã‚Š
    has_estimate: hasEstimate,
    estimate_repairs: estItems,
    estimate_total: estTotal,
    estimate_expiry: estExpiry,
    estimate_note: estNote,

    // ãƒ¡ãƒ¢ãƒ»ç†ç”±
    staff_memo: document.getElementById('staff_memo').value,
    cancel_reason: document.getElementById('loss_reason') ? document.getElementById('loss_reason').value : '',
  };

  let gasResult = {};
  try {
    const resp = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
    gasResult = await resp.json();
  } catch(e) {
    console.log('é€ä¿¡å®Œäº†ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æå¤±æ•—ï¼‰');
  }

  // å®Œäº†ç”»é¢
  document.getElementById('main_view').classList.add('hidden');
  document.getElementById('done_view').classList.remove('hidden');

  // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const doneMsg = document.getElementById('done_msg');
  if (status === 'å®Œå·¥') doneMsg.innerHTML = 'âœ… å®Œäº†å ±å‘Šã‚’é€ä¿¡ã—ã¾ã—ãŸ';
  else if (status === 'å¤±æ³¨') doneMsg.innerHTML = 'âŒ å¤±æ³¨ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸ';
  else if (status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') doneMsg.innerHTML = 'ğŸš« ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸ';
  else if (isReserveEst) doneMsg.innerHTML = 'ğŸ“„ äºˆç´„ã¨ã—ã¦è¨˜éŒ²ã—ã€è¦‹ç©æ›¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ';
  else doneMsg.innerHTML = 'ğŸ“… äºˆç´„ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆå¾Œè¿½ã„ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾è±¡ï¼‰';

  // å£²ä¸Šç®¡ç†ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  if (gasResult.uriage_error) {
    doneMsg.innerHTML += '<br><span style="color:red;font-size:.85rem">âš  å£²ä¸Šç®¡ç†ã‚·ãƒ¼ãƒˆ: ' + gasResult.uriage_error + '</span>';
  }

  // æ›¸é¡ç™ºè¡Œãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
  const showDocSection = hasEstimate || isKankou;
  document.getElementById('doc_section').style.display = showDocSection ? 'block' : 'none';

  // payloadã‚’ä¿å­˜
  window._submittedPayload = payload;
}

// === æ›¸é¡ç™ºè¡Œï¼ˆè«‹æ±‚æ›¸ãƒ»é ˜åæ›¸ï¼‰ ===
async function generateDoc(type) {
  const btn = document.getElementById('btn_' + type);
  btn.textContent = 'ç™ºè¡Œä¸­...';
  btn.disabled = true;

  const sp = window._submittedPayload || {};
  const payload = {
    form_type: 'generate_doc',
    doc_type: type,
    case_id: P.case_id,
    name: P.name,
    email: P.email,
    tel: P.tel,
    items: sp.has_estimate ? sp.estimate_repairs : sp.today_repairs || [],
    total: sp.has_estimate ? sp.estimate_total : sp.today_total || 0,
    payment_method: sp.payment_method || '',
    transfer_deadline: sp.transfer_deadline || '',
  };

  try {
    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
  } catch(e) {
    console.log('ç™ºè¡Œå®Œäº†');
  }

  btn.textContent = (type === 'invoice' ? 'ğŸ“‘ è«‹æ±‚æ›¸' : 'ğŸ§¾ é ˜åæ›¸') + ' é€ä¿¡æ¸ˆã¿ âœ…';
  btn.classList.add('done');

  const result = document.getElementById('doc_result');
  result.textContent = (type === 'invoice' ? 'è«‹æ±‚æ›¸' : 'é ˜åæ›¸') + 'ã‚’ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã—ã¾ã—ãŸ';
  result.style.color = 'var(--green)';
}
</script>
</body>
</html>
